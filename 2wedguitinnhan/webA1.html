<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Web A - Chat M√£ h√≥a / Gi·∫£i m√£</title>
  <style>
    html, body {
      margin: 0; padding: 0; height: 100%;
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background: #001f3f;
      color: #eee;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    .card {
      width: 1000px;
      background: #112;
      border: 2px solid #0099ff;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 0 15px #0099ff;
      display: flex;
      flex-direction: row;
      gap: 20px;
    }
    .section {
      flex: 1 1 48%;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    h2, h3 {
      text-align: center;
      color: #66ccff;
      margin: 0 0 10px 0;
    }
    label {
      font-size: 0.9rem;
      color: #99ccff;
    }
    input[type=text], textarea {
      width: 100%;
      padding: 8px;
      border-radius: 8px;
      border: none;
      font-size: 1rem;
      box-sizing: border-box;
      resize: none;
      background: #222;
      color: #eee;
    }
    button {
      padding: 10px;
      border-radius: 8px;
      border: none;
      background: #0099ff;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    #status {
      margin-top: 15px;
      min-height: 20px;
      color: #99ff99;
      text-align: center;
      width: 1000px;
      font-weight: bold;
    }
    #recvCipherA, #decodedMsgA, #sendPlainA {
      height: 60px;
      background: #222;
    }
    #chatHistoryA {
      height: 200px;
      background: #111;
      color: #ccf;
      overflow-y: auto;
      padding: 10px;
      border-radius: 10px;
      white-space: pre-wrap;
      font-size: 0.95rem;
      line-height: 1.4;
    }
    .msg-block {
      margin-bottom: 12px;
      border-bottom: 1px dashed #444;
      padding-bottom: 6px;
    }
    .msg-block strong {
      color: #66ccff;
    }
  </style>
</head>
<body>
  <div class="card">
    <!-- G·ª≠i -->
    <div class="section">
      <h2>Web A - Chat M√£ h√≥a / Gi·∫£i m√£</h2>
      <h3>G·ª≠i tin nh·∫Øn</h3>
      <label for="sendPlainA">Tin nh·∫Øn g·ªëc:</label>
      <textarea id="sendPlainA" placeholder="Nh·∫≠p tin nh·∫Øn..."></textarea>
      <label for="sendKeyA">Kh√≥a m√£ h√≥a:</label>
      <input type="text" id="sendKeyA" placeholder="Nh·∫≠p kh√≥a m√£ h√≥a" />
      <button id="sendBtnA">M√£ h√≥a & G·ª≠i</button>
    </div>

    <!-- Nh·∫≠n -->
    <div class="section">
      <h3>Nh·∫≠n tin nh·∫Øn</h3>
      <label for="recvCipherA">Tin nh·∫Øn m√£ h√≥a nh·∫≠n ƒë∆∞·ª£c:</label>
      <textarea id="recvCipherA" readonly></textarea>
      <label for="recvKeyA">Kh√≥a gi·∫£i m√£:</label>
      <input type="text" id="recvKeyA" placeholder="Nh·∫≠p kh√≥a gi·∫£i m√£" />
      <button id="decodeBtnA">Gi·∫£i m√£</button>
      <label for="decodedMsgA">Tin nh·∫Øn sau gi·∫£i m√£:</label>
      <textarea id="decodedMsgA" readonly></textarea>
    </div>
  </div>

  <!-- L·ªãch s·ª≠ h·ªôi tho·∫°i -->
  <div style="width: 1000px; margin-top: 20px;">
    <h3>L·ªãch s·ª≠ h·ªôi tho·∫°i</h3>
    <div id="chatHistoryA"></div>
  </div>

  <div id="status">ƒêang k·∫øt n·ªëi WebSocket...</div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <script>
    const ws = new WebSocket("ws://localhost:8080");
    const status = document.getElementById("status");

    const sendPlainA = document.getElementById("sendPlainA");
    const sendKeyA = document.getElementById("sendKeyA");
    const sendBtnA = document.getElementById("sendBtnA");

    const recvCipherA = document.getElementById("recvCipherA");
    const recvKeyA = document.getElementById("recvKeyA");
    const decodeBtnA = document.getElementById("decodeBtnA");
    const decodedMsgA = document.getElementById("decodedMsgA");

    const chatHistory = document.getElementById("chatHistoryA");

    let lastCipherText = "";
    let lastDecrypted = "";

    ws.onopen = () => {
      status.textContent = "‚úÖ K·∫øt n·ªëi WebSocket th√†nh c√¥ng.";
    };

    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      if(data.status === "chat_message" && data.sender === "B") {
        recvCipherA.value = data.message;
        lastCipherText = data.message;
        status.textContent = "üì® Nh·∫≠n tin nh·∫Øn m√£ h√≥a t·ª´ Web B.";
      }
    };

    decodeBtnA.onclick = () => {
      const cipher = recvCipherA.value.trim();
      const key = recvKeyA.value.trim();
      if(!cipher || !key) {
        alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß d·ªØ li·ªáu ƒë·ªÉ gi·∫£i m√£.");
        return;
      }
      try {
        const decrypted = CryptoJS.AES.decrypt(cipher, key).toString(CryptoJS.enc.Utf8);
        if(!decrypted) {
          decodedMsgA.value = "‚ö†Ô∏è Gi·∫£i m√£ th·∫•t b·∫°i ho·∫∑c sai kh√≥a.";
          status.textContent = "‚ùå Gi·∫£i m√£ th·∫•t b·∫°i.";
        } else {
          decodedMsgA.value = decrypted;
          lastDecrypted = decrypted;
          status.textContent = "‚úÖ Gi·∫£i m√£ th√†nh c√¥ng.";
        }
      } catch (e) {
        decodedMsgA.value = "‚ö†Ô∏è L·ªói khi gi·∫£i m√£.";
        status.textContent = "‚ùå L·ªói khi gi·∫£i m√£.";
      }
    };

    sendBtnA.onclick = () => {
      const replyMsg = sendPlainA.value.trim();
      const key = sendKeyA.value.trim();
      if(!replyMsg || !key) {
        alert("Vui l√≤ng nh·∫≠p tin nh·∫Øn v√† kh√≥a m√£ h√≥a.");
        return;
      }
      const encrypted = CryptoJS.AES.encrypt(replyMsg, key).toString();
      ws.send(JSON.stringify({action: "send_message", sender: "A", message: encrypted}));

      // Th√™m kh·ªëi h·ªôi tho·∫°i v√†o l·ªãch s·ª≠
      const block = document.createElement("div");
      block.className = "msg-block";
      block.innerHTML = `
        <strong>B (m√£ h√≥a):</strong>\n${lastCipherText}
        <br><strong>‚Üí Gi·∫£i m√£:</strong> ${lastDecrypted}
        <br><strong>‚Üí Tr·∫£ l·ªùi:</strong> ${replyMsg}
      `;
      chatHistory.appendChild(block);
      chatHistory.scrollTop = chatHistory.scrollHeight;

      // Reset
      sendPlainA.value = "";
      sendKeyA.value = "";
      decodedMsgA.value = "";
      recvCipherA.value = "";
      recvKeyA.value = "";
      status.textContent = "üì§ Tin nh·∫Øn ƒë√£ ƒë∆∞·ª£c m√£ h√≥a v√† g·ª≠i ƒëi.";
    };
  </script>
</body>
</html>
