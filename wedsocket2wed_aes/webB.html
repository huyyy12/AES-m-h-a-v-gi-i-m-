<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Web B - M√£ h√≥a, g·ª≠i v√† nh·∫≠n file</title>
  <style>
    body, html {
      margin: 0; padding: 0; height: 100%;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: url('https://images.unsplash.com/photo-1517694712202-14dd9538aa97?auto=format&fit=crop&w=1470&q=80') no-repeat center center fixed;
      background-size: cover;
      display: flex;
      justify-content: center;
      align-items: center;
      color: #eee;
      overflow: hidden;
    }
    body::before {
      content: "";
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background-color: rgba(204, 51, 51, 0.35);
      z-index: 0;
    }
    .card {
      position: relative;
      z-index: 1;
      background: rgba(50, 20, 20, 0.85);
      border: 3px solid #cc3333;
      border-radius: 20px;
      width: 400px;
      padding: 35px 30px;
      box-shadow: 0 0 30px #cc3333;
      box-sizing: border-box;
      text-align: center;
      display: flex;
      flex-direction: column;
      gap: 18px;
      user-select: none;
    }
    h2 {
      margin: 0 0 20px 0;
      font-weight: 800;
      font-size: 1.7rem;
      color: #ff6666;
    }
    input[type="file"],
    input[type="text"],
    select {
      width: 100%;
      padding: 14px 12px;
      border-radius: 12px;
      border: none;
      font-size: 1rem;
      outline: none;
      background-color: #222;
      color: #eee;
      box-sizing: border-box;
      cursor: pointer;
    }
    input[type="text"] {
      cursor: text;
    }
    button {
      width: 100%;
      padding: 14px 0;
      border: none;
      border-radius: 12px;
      background: #cc3333;
      font-weight: 700;
      color: #222;
      cursor: pointer;
      font-size: 1.15rem;
      transition: background-color 0.3s ease;
      box-sizing: border-box;
    }
    button:hover:not(:disabled) {
      background-color: #a02a2a;
      color: #111;
    }
    button:disabled {
      background-color: #ff666699;
      cursor: not-allowed;
    }
    #statusB {
      min-height: 1.5em;
      font-weight: 700;
      margin-top: 10px;
      color: #ff6666;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="card">
    <h2>Web B - M√£ h√≥a & g·ª≠i file</h2>

    <input type="file" id="fileInputB" />
    <input type="text" id="keyInputB" placeholder="Nh·∫≠p kh√≥a AES" />
    <button id="sendBtnB" disabled> M√£ h√≥a v√† g·ª≠i (Web B ‚Üí Server)</button>

    <h3>Danh s√°ch file t·ª´ Web A</h3>
    <select id="fileListA" size="5" style="height: 120px;"></select>
    <button id="downloadBtnB" disabled>T·∫£i v√† gi·∫£i m√£ file ƒë√£ ch·ªçn</button>

    <p id="statusB"></p>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <script>
    const wsB = new WebSocket("ws://localhost:8080");
    const statusB = document.getElementById("statusB");
    const sendBtnB = document.getElementById("sendBtnB");
    const downloadBtnB = document.getElementById("downloadBtnB");
    const fileListA = document.getElementById("fileListA");

    wsB.onopen = () => {
      statusB.textContent = "‚úÖ K·∫øt n·ªëi WebSocket th√†nh c√¥ng.";
      sendBtnB.disabled = false;
      fetchFileListA();
    };

    wsB.onerror = () => {
      statusB.textContent = "‚ùå L·ªói k·∫øt n·ªëi WebSocket.";
      sendBtnB.disabled = true;
      downloadBtnB.disabled = true;
    };

    wsB.onclose = () => {
      statusB.textContent = "‚ö†Ô∏è K·∫øt n·ªëi b·ªã ƒë√≥ng.";
      sendBtnB.disabled = true;
      downloadBtnB.disabled = true;
    };

    wsB.onmessage = (event) => {
      const data = JSON.parse(event.data);
      if (data.status === "file_received_B") {
        statusB.textContent = "‚úÖ Server ƒë√£ nh·∫≠n file m√£ h√≥a t·ª´ Web B.";
      }
      else if (data.status === "list_files_A") {
        updateFileList(fileListA, data.files);
      }
      else if (data.status === "file_ready_A") {
        statusB.textContent = "üì• ƒê√£ nh·∫≠n file t·ª´ Web A, ƒëang gi·∫£i m√£...";
        decryptAndDownload(data.file, data.filename);
      }
      else if (data.status === "no_file_A") {
        statusB.textContent = "‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y file tr√™n server.";
      }
    };

    sendBtnB.onclick = () => {
      const fileInput = document.getElementById("fileInputB");
      const key = document.getElementById("keyInputB").value.trim();

      if (!fileInput.files.length) {
        alert("Vui l√≤ng ch·ªçn file");
        return;
      }
      if (!key) {
        alert("Vui l√≤ng nh·∫≠p kh√≥a");
        return;
      }

      const file = fileInput.files[0];
      const reader = new FileReader();
      reader.onload = (e) => {
        const wordArray = CryptoJS.lib.WordArray.create(e.target.result);
        const encrypted = CryptoJS.AES.encrypt(wordArray, key).toString();

        const msg = {
          action: "send_encrypted_B",
          fileData: encrypted,
          filename: file.name,
          source: "B"
        };
        wsB.send(JSON.stringify(msg));
        statusB.textContent = "‚è≥ ƒêang g·ª≠i file m√£ h√≥a l√™n server...";
      };
      reader.readAsArrayBuffer(file);
    };

    downloadBtnB.onclick = () => {
      const selectedFile = fileListA.value;
      if (!selectedFile) {
        alert("Vui l√≤ng ch·ªçn file t·ª´ danh s√°ch");
        return;
      }
      const key = document.getElementById("keyInputB").value.trim();
      if (!key) {
        alert("Vui l√≤ng nh·∫≠p kh√≥a ƒë·ªÉ gi·∫£i m√£");
        return;
      }

      wsB.send(JSON.stringify({
        action: "request_file_A",
        filename: selectedFile
      }));
      statusB.textContent = "‚è≥ ƒêang y√™u c·∫ßu file t·ª´ server...";
    };

    function fetchFileListA() {
      if (wsB.readyState === WebSocket.OPEN) {
        wsB.send(JSON.stringify({ action: "list_files_A" }));
      }
    }

    function updateFileList(selectElem, files) {
      selectElem.innerHTML = "";
      if (files.length === 0) {
        const opt = document.createElement("option");
        opt.textContent = "Ch∆∞a c√≥ file n√†o";
        opt.disabled = true;
        selectElem.appendChild(opt);
      } else {
        for (const f of files) {
          const opt = document.createElement("option");
          opt.value = f;
          opt.textContent = f;
          selectElem.appendChild(opt);
        }
      }
      downloadBtnB.disabled = files.length === 0;
    }

    function convertWordArrayToUint8Array(wordArray) {
      const len = wordArray.sigBytes;
      const words = wordArray.words;
      const u8 = new Uint8Array(len);
      let idx = 0;
      for (let i = 0; i < words.length; i++) {
        let word = words[i];
        for (let j = 3; j >= 0; j--) {
          if (idx < len) {
            u8[idx++] = (word >> (8 * j)) & 0xff;
          }
        }
      }
      return u8;
    }

    function decryptAndDownload(encrypted, filename) {
      const key = document.getElementById("keyInputB").value.trim();
      try {
        const decrypted = CryptoJS.AES.decrypt(encrypted, key);
        const uint8Arr = convertWordArrayToUint8Array(decrypted);
        const blob = new Blob([uint8Arr]);
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        a.click();
        URL.revokeObjectURL(a.href);
        statusB.textContent = "‚úÖ File ƒë√£ gi·∫£i m√£ v√† t·∫£i v·ªÅ.";
      } catch (e) {
        statusB.textContent = "‚ùå Gi·∫£i m√£ th·∫•t b·∫°i: kh√≥a sai ho·∫∑c file l·ªói.";
      }
    }
  </script>
</body>
</html>
